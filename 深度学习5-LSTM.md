# LSTM前向传播与反向传播详解

---

## 一、核心结构
$$
\begin{aligned}
遗忘门 \ f_t &= \sigma(W_f \cdot [h_{t-1}, x_t] + b_f) \\
输入门 \ i_t &= \sigma(W_i \cdot [h_{t-1}, x_t] + b_i) \\
候选记忆 \ \tilde{C}_t &= \tanh(W_c \cdot [h_{t-1}, x_t] + b_c) \\
细胞状态 \ C_t &= f_t \odot C_{t-1} + i_t \odot \tilde{C}_t \\
输出门 \ o_t &= \sigma(W_o \cdot [h_{t-1}, x_t] + b_o) \\
隐藏状态 \ h_t &= o_t \odot \tanh(C_t)
\end{aligned}
$$

---

## 二、前向传播解析

### 1. 初始化阶段
- 初始细胞状态：$C_0 = 0$
- 初始隐藏状态：$h_0 = 0$

### 2. 遗忘门计算（t=1时刻）
​**参数**​：
- 输入权重 $W_{fx} = 1.2$
- 隐藏权重 $W_{fh} = 0.8$
- 偏置项 $b_f = -0.5$

​**计算步骤**​：
$$
z_f = W_{fx} \cdot h_{t-1} + W_{fh} \cdot x_t + b_f = 1.2 \times 0.5 + 0.8 \times 0 - 0.5 = 0.1
$$
$$
f_1 = \frac{1}{1 + e^{-z_f}} = \frac{1}{1 + e^{-0.1}} \approx 0.525
$$
> ​**作用**​：保留52.5%的历史记忆

### 3. 输入门计算（t=1时刻）
​**输入门参数**​：
- $W_{ix} = 0.6$, $W_{ih} = 0.4$, $b_i = 0.1$

​**候选记忆参数**​：
- $W_{cx} = 1.0$, $W_{ch} = 0.5$, $b_c = 0.2$

​**计算过程**​：
$$
i_1 = \sigma(0.6 \times 0.5 + 0.4 \times 0 + 0.1) = \frac{1}{1 + e^{-0.3}} \approx 0.574
$$
$$
\tilde{C}_1 = \tanh(1.0 \times 0.5 + 0.5 \times 0 + 0.2) = \tanh(0.7) \approx 0.604
$$
> ​**作用**​：添加59.8%的新记忆

### 4. 状态更新（t=1时刻）
$$
C_1 = f_1 \odot C_0 + i_1 \odot \tilde{C}_1 = 0.525 \times 0 + 0.574 \times 0.604 \approx 0.347
$$
$$
h_1 = o_1 \odot \tanh(C_1) \quad (\text{需补充输出门参数})
$$

---

## 三、反向传播推导

### 1. 梯度链式法则
$$
\frac{\partial L}{\partial W_f} = \sum_{k=1}^t \left( \frac{\partial L}{\partial C_t} \cdot \prod_{m=k+1}^t f_m \cdot \sigma'(z_f) \cdot [h_{k-1}, x_k] \right)
$$

### 2. 梯度计算示例（t=2时刻）
$$
\frac{\partial C_2}{\partial W_f} = \underbrace{C_1 \cdot f_2'}_{\text{当前梯度}} + \underbrace{f_2 \cdot \frac{\partial C_1}{\partial W_f}}_{\text{历史梯度}}
$$
其中：
$$
f_2' = f_2 \odot (1 - f_2) = 0.693 \times (1 - 0.693) \approx 0.212
$$

---

## 四、梯度消失缓解

| 工作模式   | 遗忘门值 $f_t$ | 梯度传播效果       |
|------------|-------------------|--------------------|
| 长期记忆   | $f_t \approx 1$ | 梯度接近无损传递   |
| 短期记忆   | $f_t \approx 0$ | 梯度被截断         |

​**核心机制**​：  
细胞状态梯度流：$\frac{\partial C_t}{\partial C_{t-1}} = f_t$  
对比传统RNN：固定权重 → 自适应门控调节梯度  

---

## 五、数值计算实例（t=2时刻）

### 输入数据
- $x_2 = 0.8$
- $h_1 = 0.194$
- $C_1 = 0.361$

### 计算过程
1. ​**遗忘门（$f_2$）​**​：
$$
z_f = 1.2 \times 0.8 + 0.8 \times 0.194 - 0.5 = 0.815 \\
f_2 = \frac{1}{1 + e^{-0.815}} \approx 0.693
$$

2. ​**候选记忆（$\tilde{C}_2$）​**​：
$$
z_c = 1.0 \times 0.8 + 0.5 \times 0.194 + 0.2 = 1.097 \\
\tilde{C}_2 = \tanh(1.097) \approx 0.800
$$

3. ​**细胞状态更新（$C_2$）​**​：
$$
C_2 = f_2 \odot C_1 + i_2 \odot \tilde{C}_2 = 0.693 \times 0.361 + 0.658 \times 0.800 \approx 0.760
$$

4. ​**隐藏状态（$h_2$）​**​：
$$
o_2 = \sigma(0.9 \times 0.8 + 0.3 \times 0.194 - 0.2) \approx 0.641 \\
h_2 = o_2 \odot \tanh(C_2) \approx 0.641 \times 0.683 \approx 0.438
$$

---

## 六、设计思想

### 核心组件与功能
| 组件       | 功能                     | 数学表达                   |
|------------|--------------------------|----------------------------|
| 遗忘门     | 筛选历史记忆             | $f_t = \sigma(W_f \cdot [h, x] + b)$ |
| 输入门     | 控制新记忆写入           | $i_t = \sigma(W_i \cdot [h, x] + b)$ |
| 输出门     | 调节当前输出             | $o_t = \sigma(W_o \cdot [h, x] + b)$ |

### 架构优势
1. ​**梯度高速公路**​：细胞状态直通路径缓解梯度消失  
2. ​**门控自适应**​：动态调节信息流强度  
3. ​**双曲正切对称性**​：平衡梯度正负传播  
4. ​**长期记忆保留**​：遗忘门维持关键历史信息  

> ​**关键设计总结**​  
> ✅ 门控机制独立控制信息流动  
> ✅ 细胞状态提供梯度传播稳定通道  
> ✅ 参数共享降低模型复杂度  
